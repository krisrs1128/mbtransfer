---
title: "Example with Generalized Lotka Volterra"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example with Generalized Lotka Volterra}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r}
library(glue)
library(mbtransfer)
library(seqtime)
library(tidyverse)
theme_set(tfPaper::my_theme())
set.seed(20240401)

pivot_glv <- function(ts, n_subject = 16) {
  if (is.null(colnames(ts@series[[1]]))) {
    for (i in seq_along(ts@series)) {
      colnames(ts@series[[i]]@values) <- names(ts@series[[i]]@time)
    }
  }

  pivot_ts(ts) |>
    filter(subject %in% 1:n_subject)
}

plot_ts <- function(ts, ts_preds) {
  diff <- ts - ts_preds
  ts_df <- bind_rows(
    pivot_glv(ts),
    pivot_glv(ts_preds),
    .id = "source"
  ) |>
    mutate(
      source = ifelse(source == "1", "True", "Predicted"),
      source = factor(source, c("True", "Predicted")),
      subject = factor(
        subject,
        levels = order(
          map_dbl(diff@series, ~ sum(abs(.@values)))
        )
      )
    )

  ggplot(ts_df) +
    geom_area(
      aes(time, value, fill = taxon, col = taxon, linetype = source),
      alpha = 0.2, position = "identity", linewidth = 0.9
    ) +
    scale_y_continuous(expand = c(0, 0, 0, 0.01)) +
    facet_wrap(~subject, nrow = 2) +
    labs(x = "Time", y = "Value") +
    theme(
      legend.title = element_text(size = 16),
      strip.text = element_text(size = 14),
      legend.text = element_text(size = 14)
    )
}

simulate_oscillator <- function(n_time = 10, n_series = 500, perturb = FALSE) {
  growthchanges <- c(2, 0)
  if (perturb) {
    t_external <- seq(3, n_time, by = floor(n_time / n_species))
    duration <- rep(2, length(t_external))
    pert <- perturbation(times = t_external, duration = duration, growthchanges = growthchanges)
    t_perturb <- map(0:duration, ~ . + t_external) |>
      unlist()
  } else {
    t_perturb <- c()
  }

  A <- matrix(c(0, 1, -1, 0), nrow = 2)
  growth_rates <- c(2, -1)
  n_species <- nrow(A)
  series <- list()
  for (i in seq_len(n_series)) {
    y0 <- runif(n_species, 0, 4)
    if (perturb) {
      series[[i]] <- glv(n_species, A, growth_rates, y = y0, tend = n_time, tstep = 0.2, perturb = pert)
    } else {
      series[[i]] <- glv(n_species, A, growth_rates, y = y0, tend = n_time, tstep = 0.2)
    }
  }
  list(series = series, t_perturb = t_perturb)
}

to_ts <- function(glv_sim) {
  series <- glv_sim[[1]]
  t_perturb <- glv_sim[[2]]

  reads <- map_dfr(series, ~ as_tibble(.) |>
    mutate(taxon = row_number()) |>
    pivot_longer(-taxon, names_to = "time"),
  .id = "subject"
  ) |>
    mutate(
      time = as.numeric(time),
      time = time / time[2], # round to integers
      sample = glue("s{subject}_{time}")
    )

  interventions <- reads |>
    select(sample) |>
    mutate(P = 0) |>
    unique() |>
    column_to_rownames("sample")

  metadata <- select(reads, -value) |>
    select(subject, time, sample) |>
    unique()
  subject <- data.frame(subject = unique(metadata$subject), property = 0)
  rownames(metadata) <- metadata$sample
  rownames(interventions) <- metadata$sample

  if (length(t_perturb) > 0) {
    interventions <- interventions |>
      rownames_to_column("sample") |>
      left_join(metadata) |>
      mutate(P = 1 * (time %in% t_perturb)) |>
      select(P, sample) |>
      column_to_rownames("sample")
  }

  reads |>
    select(sample, taxon, value) |>
    pivot_wider(names_from = "taxon", values_from = "value") |>
    column_to_rownames("sample") |>
    ts_from_dfs(interventions, metadata, subject)
}
```


```{r}
ts <- simulate_oscillator() |>
  to_ts()

fit <- mbtransfer(ts[, 1:35], P = 5, Q = 1, alpha = 0, lambda = 0) # 1e-6)
ts_missing <- subset_values(ts, 1:35)
ts_preds <- predict(fit, ts_missing[1:10])
plot_ts(ts[1:10], ts_preds) +
  geom_vline(xintercept = 35, alpha = 0.4)
```

An example with perturbations.

```{r}
ts <- simulate_oscillator(perturb = TRUE, n_series = 20) |>
  to_ts()

fit <- mbtransfer(ts[, 1:35], P = 5, Q = 5, alpha = 0, lambda = 0)
ts_missing <- subset_values(ts, 1:35)
ts_preds <- predict(fit, ts_missing[1:16])
plot_ts(ts[1:16], ts_preds) +
  geom_vline(xintercept = 35)
#  geom_rect(xmin = 10, xmax = 26, ymin = -Inf, ymax = Inf, alpha = 0.01, fill = "#f6f6f6") +
#  geom_rect(xmin = 60, xmax = 76, ymin = -Inf, ymax = Inf, alpha = 0.01, fill = "#f6f6f6")
```
