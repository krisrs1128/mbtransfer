<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mbtransfer">
<title>Diet Interventions as Ecological Shifts • mbtransfer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.5/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.5/font.css" rel="stylesheet">
<link href="../deps/Cormorant-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Diet Interventions as Ecological Shifts">
<meta property="og:description" content="mbtransfer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mbtransfer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/aqua.html">Modulating pH in an Aquaculture Microbiome</a>
    <a class="dropdown-item" href="../articles/diet.html">Diet Interventions as Ecological Shifts</a>
    <a class="dropdown-item" href="../articles/postpartum.html">Postpartum Community Remodeling</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Diet Interventions as Ecological Shifts</h1>
            
      
      
      <div class="d-none name"><code>diet.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="data-and-problem-context">Data and Problem Context<a class="anchor" aria-label="anchor" href="#data-and-problem-context"></a>
</h3>
<p>(David, Maurice, Carmody, Gootenberg, Button, Wolfe, Ling, Devlin,
Varma, Fischbach, Biddinger, Dutton, and Turnbaugh, 2013) was one of the
first studies to draw attention to the way the human microbiomes could
quickly respond to changes in host behavior. This had implications for a
lot of how we think of the microbiome in health and disease – it
wouldn’t make sense to try engineering/manipulating human microbiomes if
it were not as sensitive to external change as the study found.</p>
<p>The study includes 20 participates, half of whom were assigned to
“plant” and “animal” diet interventions. Samples were collected over two
weeks, and during (what must have been a quite memorable…) five
consecutive days of the study, participants were instructed to only eat
foods from their intervention diet type. If you think of the microbiome
as an ecosystem, such a dramatic shift in diet could be likened to an
extreme environmental event, like a flood or a wildfire. The question
was how the microbiome changed in response – which taxa (if any) were
affected, and how long did the intervention effects last.</p>
<p>Before diving into the data, let’s load some libraries. The
<code>th</code> definition is just used to customize the default
<code>ggplot2</code> figure appearance.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mbtransfer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="va">th</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#f7f7f7"</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#0c0c0c"</span>, linewidth <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="va">th</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20230524</span><span class="op">)</span></span></code></pre></div>
<p>The block below reads in the data. These are <a href="https://github.com/krisrs1128/microbiome_interventions/blob/main/scripts/data_preprocessing.Rmd" class="external-link">lightly
processed</a> versions of data hosted in the <a href="https://github.com/gerberlab/mitre/tree/master/mitre/example_data/david" class="external-link"><code>MITRE</code>
repository</a> (Bogart, Creswell, and Gerber, 2019). We’ve selected only
those features that are used in this analysis, and we have reshaped the
data into a format that can be used by our <code>ts_from_dfs</code>
function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subject</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40275934/subject.csv"</span><span class="op">)</span></span>
<span><span class="va">interventions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40279171/interventions.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="va">reads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40279108/reads.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40275943/samples.csv"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we unify the read counts, subject variables, and intervention
status into a <code>ts_inter</code> class. All of
<code>mbtransfer</code>’s functions expect data structured according to
this class. We interpolate all the timepoints onto a daily grid. This is
not the most satisfying transformation, since it can create the
impression that there is not much noise between samples. However, it is
common practice (e.g., <code>r</code>Citep(bib,
“RuizPerez2019DynamicBN”)`), and it is better than entirely ignoring
variation in the gaps between samples.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">reads</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/ts_from_dfs.html">ts_from_dfs</a></span><span class="op">(</span><span class="va">interventions</span>, <span class="va">samples</span>, <span class="va">subject</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">interpolate</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>Before doing any modeling, let’s visualize some of the raw data. The
plot below shows interpolated series for the seven most abundant taxa.
For some subjects, there is a clear, nearly universal affect – e.g.,
OTU000011 is clearly depleted in the Animal diet. Other taxa have more
ambiguous effects (does OTU000019. increase in plant?), or seem
potentially specialized to subpopulations (e.g., OTU000003 in Animal).
Our transfer function models should help us provide a precise
characterization of the intervention effects, together with some
uncertainty quantification.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">values_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pivot_ts.html">pivot_ts</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span>
<span><span class="va">top_taxa</span> <span class="op">&lt;-</span> <span class="va">values_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">mean</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span></span>
<span></span>
<span><span class="va">values_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">interaction_hm</span><span class="op">(</span><span class="va">top_taxa</span>, <span class="st">"diet"</span><span class="op">)</span></span></code></pre></div>
<p><img src="diet_files/figure-html/unnamed-chunk-5-1.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="prediction">Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h3>
<p>Before we can get to those more formal statistical inferences, let’s
see how accurate the transfer function model is – there is no point
attempting to interpret effects in a model that doesn’t fit the data!
First, we are going to remove the intervention group label.
<code>mbtransfer</code> will include any column of
<code>subject_data(ts)</code> in the regression model, and since we
already record intervention state in the <code>interventions</code> slot
of the <code>ts</code> object, including a feature about the group label
doesn’t add any real information.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">subject_data</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">subject_data</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">diet</span><span class="op">)</span></span></code></pre></div>
<p>We’ll first fit a transfer function model using the first eight,
pre-intervention timepoints from every subject. It’s possible that this
model might overfit to the (relatively small) sample, but it’s still
usually helpful to compare in and out-of-sample prediction performance.
This is because poor performance even within the in-sample setting might
mean the assumed model class is not rich enough.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ts_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbtransfer.html">mbtransfer</a></span><span class="op">(</span><span class="va">ts</span>, P <span class="op">=</span> <span class="fl">2</span>, Q <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ts_missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subset_values.html">subset_values</a></span><span class="op">(</span><span class="va">ts</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">ts_preds</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">ts_missing</span><span class="op">)</span></span></code></pre></div>
<p>The block below instead trains on five subjects from each
intervention group and makes predictions for those who were held
out.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fits</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbtransfer.html">mbtransfer</a></span><span class="op">(</span><span class="va">ts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">11</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span><span class="op">]</span>, P <span class="op">=</span> <span class="fl">2</span>, Q <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ts_preds</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">ts_missing</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">16</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Let’s compare the two types of prediction performance. We’ll consider
several time horizons (using the sequence of <span class="math inline">\(\hat{y}_{t + h}\)</span> to make predictions of
<span class="math inline">\(\hat{y}_{t + h + 1}\)</span>) and
distinguish between taxa with lower/higher overall abundance. Our
predictions seem reasonable for the higher abundance taxa. However, the
blue points are more spread out than the purple in the bottom panels,
meaning that our model has overfit the lower abundance taxa. This is
perhaps not surprising: The core microbiome might be shared across all
20 participants, but the person-to-person variability might be too high
for us to make reasonable generalizations for less abundant taxa.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">ts_preds</span>, <span class="op">~</span> <span class="fu">reshape_preds</span><span class="op">(</span><span class="va">ts</span>, <span class="va">.</span><span class="op">)</span>, .id <span class="op">=</span> <span class="st">"generalization"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">h</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">h</span> <span class="op">&lt;</span> <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#400610"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">y_hat</span>, col <span class="op">=</span> <span class="va">generalization</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">.7</span>, alpha <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">quantile</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">quantile</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"lag {h}"</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html" class="external-link">hat</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"Generalization"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#A65883"</span>, <span class="st">"#6593A6"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span><span class="st">"color"</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>      panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>,</span>
<span>      strip.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>      legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span></code></pre></div>
<p><img src="diet_files/figure-html/unnamed-chunk-9-1.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="attribution-analysis-selecting-important-taxa">Attribution Analysis: Selecting Important Taxa<a class="anchor" aria-label="anchor" href="#attribution-analysis-selecting-important-taxa"></a>
</h3>
<p>Let’s see how to draw inferences from the trained model (in the
spirit of (Efron, 2020)). Our inference procedure is based on repeated
data splitting, so it should place high uncertainty around those effects
that do not reproduce across different subsets of subjects, an
especially useful check, considering the potential for overfitting we
saw above.</p>
<p>The block below defines counterfactual interventions using the
<code>steps</code> helper function. The first argument specifies which
of the perturbations to generate in that counterfactual, the second
gives the candidate intervention lengths, and the last gives the length
of the overall output sequence.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Plant"</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="st">"Animal"</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, L <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Plant"</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="st">"Animal"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, L <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ws</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;        t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; Plant   0  0  0  0</span></span>
<span><span class="co">#&gt; Animal  0  0  0  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;        t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; Plant   1  0  0  0</span></span>
<span><span class="co">#&gt; Animal  0  0  0  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;        t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; Plant   0  0  0  0</span></span>
<span><span class="co">#&gt; Animal  1  1  1  1</span></span></code></pre></div>
<p>The block below runs an instantiation of the mirror statistics FDR
controlling algorithm of (Dai, Lin, Xing, and Liu, 2020). We’ll be
contrasting the counterfactual no-intervention and the long
animal-intervention <code>ws</code>. By default, we’ll control the FDR
at a <span class="math inline">\(q\)</span>-value of 0.2, meaning that,
on average, a fifth of the “discoveries” are expected to be false
positives. You can modify this choice using the <code>qvalue</code>
argument in <code>select_taxa</code>. We have chosen a large value of
<code>n_splits</code>, since higher values generally lead to better
power. However, this takes time, and you can reset the value of
<code>n_splits</code> to a smaller value and still work through the rest
of this vignette (many taxa will still be easily detectable).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#staxa &lt;- select_taxa(ts, ws[[1]], ws[[10]],  \(x) mbtransfer(x, 2, 2), n_splits = 25)</span></span>
<span><span class="va">staxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://github.com/krisrs1128/mbtransfer_demo/raw/main/staxa-diet.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In addition to the selected set of taxa, this function returns the
mirror statistics for for each taxon. These statistics are larger for
taxa with clearer sensitivity to the intervention. We’ve chosen the 50
taxa with the largest average mirror statistics for visualization
(whether or not they were large enough to be considered
discoveries).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">staxa</span><span class="op">$</span><span class="va">ms</span> <span class="op">&lt;-</span> <span class="va">staxa</span><span class="op">$</span><span class="va">ms</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    taxon <span class="op">=</span> <span class="fu">taxa</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span><span class="op">[</span><span class="va">taxon</span><span class="op">]</span>,</span>
<span>    lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">lag</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">vis_otus</span> <span class="op">&lt;-</span> <span class="va">staxa</span><span class="op">$</span><span class="va">ms</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">m</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span></span>
<span></span>
<span><span class="va">focus_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">staxa</span><span class="op">$</span><span class="va">taxa</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The figure below shows the mirror statistics for each taxon and at
each lag. In general, the effects build up gradually across all the lags
included in the model (<span class="math inline">\(Q = 3\)</span>). This
gives evidence that considering only instantaneous intervention effects
is not sufficient (for example, this suggests that the generalized Lotka
Volterra would likely underfit).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">staxa</span><span class="op">$</span><span class="va">ms</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">taxon</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">vis_otus</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">taxon</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">focus_taxa</span>, <span class="st">"Selected"</span>, <span class="st">"Unselected"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"#d3d3d3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">taxon</span>, <span class="op">-</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, fill <span class="op">=</span> <span class="va">lag</span>, col <span class="op">=</span> <span class="va">lag</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">selected</span>, scales <span class="op">=</span> <span class="st">"free_x"</span>, space <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#c6dbef"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#2171b5"</span>, <span class="st">"#084594"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#c6dbef"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#2171b5"</span>, <span class="st">"#084594"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">M</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"Taxon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="diet_files/figure-html/unnamed-chunk-13-1.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="comparing-counterfactual-trajectories">Comparing Counterfactual Trajectories<a class="anchor" aria-label="anchor" href="#comparing-counterfactual-trajectories"></a>
</h3>
<p>Mirror statistics tell us which taxa respond to the intervention, but
they don’t tell us how they respond. For this, it’s worth simulating
forward from the different counterfactuals. The
<code>counterfactual_ts</code> function helps with this simulation task.
Given an observed series (<code>ts</code>) and counterfactuals
(<code>ws</code>), it will insert the different counterfactuals starting
at <code>start_ix</code>. From these imaginary <code>ts</code> objects,
we fill in predictions for every timepoint that appears as a column of
<code>interventions</code> but not of <code>values</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Plant"</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="st">"Animal"</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, L <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Plant"</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="st">"Animal"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, L <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/counterfactual_ts.html">counterfactual_ts</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span>, start_ix <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>sim_ts</code> object includes simulated series for every
subject. We can understand the marginal effects by summarizing across
subjects. The <code>ribbon_data</code> function computes the first and
third quartiles of the difference between each subject’s hypothetical
series. Before the intervention, the two series are expected to be
equal, but if there is a strong intervention effect, we would expect the
series to diverge after the intervention appears.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rdata</span> <span class="op">&lt;-</span> <span class="fu">ribbon_data</span><span class="op">(</span><span class="va">sim_ts</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">sim_ts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">focus_taxa</span><span class="op">)</span></span>
<span><span class="va">rdata</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 952 × 5</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   taxon [68]</span></span></span>
<span><span class="co">#&gt;    taxon      time q_lower  median q_upper</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Otu000001    -<span style="color: #BB0000;">5</span>  0       0       0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Otu000001    -<span style="color: #BB0000;">4</span>  0       0       0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Otu000001    -<span style="color: #BB0000;">3</span>  0       0       0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Otu000001    -<span style="color: #BB0000;">2</span>  0       0       0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Otu000001    -<span style="color: #BB0000;">1</span>  0.103   0.103   0.103 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Otu000001     0  0.261   0.261   0.261 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Otu000001     1  0.332   0.332   0.332 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Otu000001     2  0.324   0.324   0.324 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Otu000001     3  0.181   0.181   0.181 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Otu000001     4 -<span style="color: #BB0000;">0.012</span><span style="color: #BB0000; text-decoration: underline;">6</span> -<span style="color: #BB0000;">0.012</span><span style="color: #BB0000; text-decoration: underline;">6</span> -<span style="color: #BB0000;">0.012</span><span style="color: #BB0000; text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 942 more rows</span></span></span></code></pre></div>
<p>We can now visualize the trajectories of the selected taxa. We can
organize the taxa so that those with similar trajectory differences are
placed next to one other. Below, we do this by projecting onto the first
axis of a PCA. This visualization suggests that most of the strongly
affected taxa experience increases following the intervention, and that
the intervention often takes several days before it reaches its largest
magnitude (consistent with the increasing mirror statistics across
lags). Surprisingly, the first and third quartiles always agree with one
another. This suggests that the model has focused on effects from <span class="math inline">\(w_{t}\)</span>, and that the initial community
profiles <span class="math inline">\(y_{t}\)</span> play no role in the
model’s reduction.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rdata_wide</span> <span class="op">&lt;-</span> <span class="va">rdata</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">taxon</span>, <span class="va">time</span>, <span class="va">median</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">time</span>, values_from <span class="op">=</span> <span class="va">median</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rdata_order</span> <span class="op">&lt;-</span> <span class="va">rdata_wide</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">taxon</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">step_pca</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">juice</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>taxon <span class="op">=</span> <span class="va">rdata_wide</span><span class="op">$</span><span class="va">taxon</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">rdata</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">rdata_order</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ribbon_plot</span><span class="op">(</span>reorder_var <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Median Counterfactual Diference"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="diet_files/figure-html/unnamed-chunk-16-1.png" width="1152"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"~/Desktop/writing/202305/figure/counterfactual_diet_staxa.png"</span>, width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>In the spirit of progressive disclosure in data visualization, we can
plot the raw data associated with a few of these selected taxa. The
effects do seem consistent with our estimated trajectories. The weaker
effects seem to be a consequence of subject-to-subject heterogeneity.
For example, in most subjects, OTU000142 increases during the
intervention period (following day 0). However, some subjects have
delayed effects, and others don’t seem to have any effect at all.</p>
<p>Note that the trajectory visualization above is much more compact
than this full heatmap view – sifting over heatmaps like this for each
taxon would be an involved and ad-hoc effort. By first fitting a
transfer function model, we’re able to quickly narrow in on the most
promising taxa. Moreover, we have some formal guarantees that not too
many of our selected taxa are false positives. Overall, we recommend an
overall workflow that first evaluates taxa using formal models and then
investigates subject-level variation using</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxa_hm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Otu000011"</span>, <span class="st">"Otu000095"</span>, <span class="st">"Otu000434"</span>, <span class="st">"Otu000236"</span>, <span class="st">"Otu000169"</span>, <span class="st">"Otu000017"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">values_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">diet</span> <span class="op">==</span> <span class="st">"Animal"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    taxon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">taxon</span>, levels <span class="op">=</span> <span class="va">taxa_hm</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">interaction_hm</span><span class="op">(</span>taxa <span class="op">=</span> <span class="va">taxa_hm</span>, <span class="st">"diet"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#eaf7f7"</span>, high <span class="op">=</span> <span class="st">"#037F8C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#eaf7f7"</span>, high <span class="op">=</span> <span class="st">"#037F8C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Subject"</span>, fill <span class="op">=</span> <span class="st">"Rank"</span>, color <span class="op">=</span> <span class="st">"Rank"</span><span class="op">)</span></span></code></pre></div>
<p><img src="diet_files/figure-html/unnamed-chunk-17-1.png" width="1056"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"~/Downloads/diet_raw_hm.png"</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kris Sankaran, Pratheepa Jeganathan.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
