<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mbtransfer">
<title>Postpartum Community Remodeling • mbtransfer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.5/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.5/font.css" rel="stylesheet">
<link href="../deps/Cormorant-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Postpartum Community Remodeling">
<meta property="og:description" content="mbtransfer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mbtransfer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/aqua.html">Modulating pH in an Aquaculture Microbiome</a>
    <a class="dropdown-item" href="../articles/diet.html">Diet Interventions as Ecological Shifts</a>
    <a class="dropdown-item" href="../articles/postpartum.html">Postpartum Community Remodeling</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Postpartum Community Remodeling</h1>
            
      
      
      <div class="d-none name"><code>postpartum.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="data-and-problem-context">Data and Problem Context<a class="anchor" aria-label="anchor" href="#data-and-problem-context"></a>
</h3>
<p>How does birth influence the composition of the vaginal microbiome?
This question was first studied by (Costello, DiGiulio, Robaczewska,
Symul, Wong, Shaw, Stevenson, Holmes, Kwon, and Relman, 2022), who made
their data available in <a href="https://purl.stanford.edu/pz745bc9128" class="external-link">this repository</a>. We
will re-analyze these data using <code>mbtransfer</code>, viewing birth
as an intervention event with the capacity to remodel microbial
community composition. We’ll illustrate the following workflow:</p>
<ul>
<li>Construct a <code>ts_inter</code> (“time series intervention”)
object, which is the expected input of our main <code>mbtransfer</code>
modeling function.</li>
<li>Evaluate the in- and out-of-sample prediction performance of our
model.</li>
<li>Select significant taxa using mirror statistics.</li>
<li>Visualize hypothetical trajectories for significant taxa, with an
emphasis on potential interactions with subject-level features.</li>
</ul>
<p>The first three steps nearly parallel those for the diet and
aquaculture studies discussed in the other vignettes, but the third
follows an implementation specific to this problem context.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mbtransfer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="va">th</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#f7f7f7"</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#0c0c0c"</span>, linewidth <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="va">th</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20230524</span><span class="op">)</span></span></code></pre></div>
<p>To construct as <code>ts_inter</code> object, we combine the
following datasets:</p>
<ul>
<li>
<code>reads</code>: A <code>data.frame</code> of taxonomic
compositions. Rows are samples and columns are taxa.</li>
<li>
<code>samples</code>: A <code>data.frame</code> of sample-level
descriptors. This is expected to have <code>sample</code> and
<code>time</code> columns. <code>sample</code> must match the rownames
across <code>reads</code> and <code>interventions</code>.</li>
<li>
<code>subject_data</code>: A <code>data.frame</code> of
subject-level descriptors. This can be used to store information that is
not time varying.</li>
<li>
<code>interventions</code>: A <code>data.frame</code> of whose rows
are samples and columns are interventions. This can be either a binary
matrix of whether a given intervention (column) was present in a sample.
An input series can also be continuously valued – see the aquaculture
vignette ofr an example.</li>
</ul>
<p>We created these datasets by lightly processing the raw data from the
published repository. Our processing script is available here. Note that
we converted all the subject-level data to numeric variables –
<code>mbtransfer</code> does not know how to handle factor inputs, so
they must be coded first.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40322782/reads.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40322776/samples.csv"</span><span class="op">)</span></span>
<span><span class="va">subject_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40322773/subject.csv"</span><span class="op">)</span></span>
<span><span class="va">interventions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/40322770/interventions.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">"sample"</span><span class="op">)</span></span></code></pre></div>
<p>Note that, unlike most microbiome studies, these data has relatively
few taxa (29). This reflects the typically low diversity of the vaginal
microbiome.</p>
<p>Next, we will construct a <code>ts_inter</code> object using the
<code>ts_from_dfs</code> function. In their initial form, the samples
are not evenly sampled – we generally have biweekly sampling, but daily
resolution is available in the period immediately surrounding birth. 0
indicates the birth timepoint, samples with negative timepoints were
collected before birth. Our method is not able to handle nonuniform
temporal sampling, unfortunately, so we downsample to biweekly (14 day)
resolution using the <code>interpolate</code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="va">reads</span> <span class="op">|&gt;</span></span>
<span> <span class="fu">ts_from_dfs</span><span class="op">(</span><span class="va">interventions</span>, <span class="va">samples</span>, <span class="va">subject_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span> <span class="fu">interpolate</span><span class="op">(</span>delta <span class="op">=</span> <span class="fl">14</span>, method <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>Now that we have constructed our interpolated <code>ts_inter</code>
object, it can be helpful to visualize the subject trajectories. We can
use <code>pivot_ts</code> to convert the <code>ts_inter</code> object
into a merged <code>data.frame</code>, and
<code>interaction_barcode</code> creates a faceted plot for selected
taxa. Each row below is the trajectory for one taxon from one subject.
Multiple taxa for each subject are grouped into the same facet (for an
alternative which groups subjects according to taxa, see the
<code>interaction_hm</code> function). We’ve further grouped subjects
according to their contraception status.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">values_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pivot_ts.html">pivot_ts</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span>
<span><span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lactobacillus"</span>, <span class="st">"Prevotella"</span><span class="op">)</span></span>
<span><span class="fu">interaction_barcode</span><span class="op">(</span><span class="va">values_df</span>, <span class="va">taxa</span>, <span class="st">"BirthControlYesNo"</span>, width <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span></code></pre></div>
<p><img src="postpartum_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="prediction">Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h2>
<p>We’ll now fit and evaluate some <code>mbtransfer</code> models. We
consider two fits – one which uses all the subjects, and another that
estimates using 25/49 of them. In both models, we use taxonomic
(<code>P</code>) and intervention (<code>Q</code>) lags of three
timepoints. In these data, that means we can look 6 weeks into the past
to predict current microbiome composition.</p>
<p>The model that uses all samples gives us a sense of the flexibility
of the approach. If we think of the model as a denoiser / smoothing
according to a subset of predictor composition, intervention, and
subject descriptors, how closely can we predict community change? The
second model gives us a sense of how well this model might generalize to
new subjects. This is a harder question, because microbiome data tends
to exhibit high subject-to-subject variability. That said, taxa which
are predictable out-of-sample are worth noting, since their effects may
be more general.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">subject_data</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">subject_data</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">BirthControlYesNo</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>BirthControlYesNo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">BirthControlYesNo</span> <span class="op">==</span> <span class="st">"Yes"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbtransfer.html">mbtransfer</a></span><span class="op">(</span><span class="va">ts</span>, P <span class="op">=</span> <span class="fl">2</span>, Q <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">fits</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbtransfer.html">mbtransfer</a></span><span class="op">(</span><span class="va">ts</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span>, P <span class="op">=</span> <span class="fl">2</span>, Q <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The block below computes the in and out of sample prediction errors
corresponding to these two models. On test samples, we are allowed to
look at timepoints up to week 12. We stop here because some samples have
birth events starting on week 13, and we want to predict the effect of
an intervention from before any have occurred.</p>
<p>By default, the predict function will fill in any timepoints that are
present in the <code>intervention</code> but not the abundance
<code>values</code> slot of each <code>ts_inter</code> element. This
means that we will extrapolate starting from timepoint all the way to
the end of sampling (roughly, 35 - 45 samples total). Below, we will
compare predictions across different time horizons. Since running
inference can take time, one simple way to speed up
<code>mbtransfer</code> is to request predictions across shorter time
horizons (e.g., by reducing the number of columns in the
<code>interventions</code> slot).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ts_missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subset_values.html">subset_values</a></span><span class="op">(</span><span class="va">ts</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">ts_preds</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">ts_missing</span><span class="op">)</span></span>
<span><span class="va">ts_preds</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"out-of-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">ts_missing</span><span class="op">[</span><span class="fl">26</span><span class="op">:</span><span class="fl">49</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We compare the true vs. predicted abundances in the block below.
Samples with more accurate predictions lie nearer to the diagonal. We’ve
split the taxa by abundance – row labels give quantiles of average
abundance. Note that each row has a different <span class="math inline">\(y\)</span> axis. The clearest patterns are
that,</p>
<ul>
<li>Short time horizons are easier to predict than long ones.</li>
<li>In all panels, in and out-of-sample performance seem comparable, so
we don’t have to be too worried about overfitting.</li>
<li>More abundant taxa appear slightly easier to predict. This partly
reflects the high noise level of the underlying data. For rarer taxa,
however, many errors come from the model’s inability to predict exact
zeros. This could potentially be improved by altering the model
form.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">ts_preds</span>, <span class="op">~</span> <span class="fu">reshape_preds</span><span class="op">(</span><span class="va">ts</span>, <span class="va">.</span><span class="op">)</span>, .id <span class="op">=</span> <span class="st">"generalization"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">h</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">h</span> <span class="op">&lt;</span> <span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">h</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#400610"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">y_hat</span>, col <span class="op">=</span> <span class="va">generalization</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">.7</span>, alpha <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">quantile</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">quantile</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"lags {h + 1} - {h + 10}"</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html" class="external-link">hat</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"Generalization"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#A65883"</span>, <span class="st">"#6593A6"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span><span class="st">"color"</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>      panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>,</span>
<span>      strip.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>      legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span></code></pre></div>
<p><img src="postpartum_files/figure-html/unnamed-chunk-9-1.png" width="960"></p>
<div class="section level3">
<h3 id="attribution-analysis-selecting-important-taxa">Attribution Analysis: Selecting Important Taxa<a class="anchor" aria-label="anchor" href="#attribution-analysis-selecting-important-taxa"></a>
</h3>
<p>Given the reasonable performance of the model, it makes sense to try
following-up with some more formal statistical inference. Specifically,
we want to know which taxa are most affected by the intervention, but we
some formal statistical guarantees that we aren’t reading too much into
anything that is just noise. To this end, we have included a
<code>select_taxa</code> function that performs selective inference
through data splitting, following (Dai, Lin, Xing, and Liu, 2020).
Roughly, we estimate marginal effects of different hypothetical
interventions on each taxa. We do this over. many random splits of the
data, and if a similar marginal effects is detected across the. splits,
then we intuitively suspect that the intervention does influence that
taxa. The algorithm in (Dai, Lin, Xing et al., 2020) formalizes this
intuition in a way that ensures that the false discovery rate is
controlled. See the manuscript accompanying the package for details.</p>
<p>Practically, to implement this selection algorithm, we need to
provide the counterfactual interventions that we want to contrast. This
is done in the step below. The <code>steps</code> helper function
creates a few example counterfactuals.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"birth"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, L <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">ws</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;       t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; birth  0  0  0  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;       t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; birth  1  1  0  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;       t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; birth  1  1  1  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt;       t1 t2 t3 t4</span></span>
<span><span class="co">#&gt; birth  1  1  1  1</span></span></code></pre></div>
<p>We’ll contrast the taxa trajectories when the first two timepoints
are and are not assumed to belong to the <code>birth</code>
intervention. By default, we control the FDR at a <span class="math inline">\(q\)</span>-level of 0.2 – this can be modified
using the <code>qvalue</code> argument. We have to fit our model over 20
random splits of the data, so this step takes some time. More splits
yields higher power, but small values <code>n_splits</code> will still
guarantee FDR control, and you will still be able to run the rest of the
vignette even if you set <code>n_splits</code> to a value like 3 or
4.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">staxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_taxa.html">select_taxa</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span> <span class="fu"><a href="../reference/mbtransfer.html">mbtransfer</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, n_splits <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="co">#&gt; Training models for split 1/25</span></span>
<span><span class="co">#&gt; Training models for split 2/25</span></span>
<span><span class="co">#&gt; Training models for split 3/25</span></span>
<span><span class="co">#&gt; Training models for split 4/25</span></span>
<span><span class="co">#&gt; Training models for split 5/25</span></span>
<span><span class="co">#&gt; Training models for split 6/25</span></span>
<span><span class="co">#&gt; Training models for split 7/25</span></span>
<span><span class="co">#&gt; Training models for split 8/25</span></span>
<span><span class="co">#&gt; Training models for split 9/25</span></span>
<span><span class="co">#&gt; Training models for split 10/25</span></span>
<span><span class="co">#&gt; Training models for split 11/25</span></span>
<span><span class="co">#&gt; Training models for split 12/25</span></span>
<span><span class="co">#&gt; Training models for split 13/25</span></span>
<span><span class="co">#&gt; Training models for split 14/25</span></span>
<span><span class="co">#&gt; Training models for split 15/25</span></span>
<span><span class="co">#&gt; Training models for split 16/25</span></span>
<span><span class="co">#&gt; Training models for split 17/25</span></span>
<span><span class="co">#&gt; Training models for split 18/25</span></span>
<span><span class="co">#&gt; Training models for split 19/25</span></span>
<span><span class="co">#&gt; Training models for split 20/25</span></span>
<span><span class="co">#&gt; Training models for split 21/25</span></span>
<span><span class="co">#&gt; Training models for split 22/25</span></span>
<span><span class="co">#&gt; Training models for split 23/25</span></span>
<span><span class="co">#&gt; Training models for split 24/25</span></span>
<span><span class="co">#&gt; Training models for split 25/25</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">staxa</span>, file <span class="op">=</span> <span class="st">"staxa-postpartum.rds"</span><span class="op">)</span></span>
<span><span class="co">#readRDS("staxa-postpartum.rds")</span></span></code></pre></div>
<p>The <code>ms</code> element of this object includes the raw mirror
statistics that led to the final inference. The larger the value of
these mirror statistics, the stronger the estimated intervention effect.
Mirror statistics that are symmetric around zero suggest that there is
no intervention effect. Visualizing these results, it seems that most
taxa in the data are affected by the intervention. This contrasts with
the other vignettes in this package, where effect seems more
taxa-specific. The result is consistent with the findings of (Costello,
DiGiulio, Robaczewska et al., 2022), though. Delivery dramatically
remodels the vaginal microbiome.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">staxa</span><span class="op">$</span><span class="va">ms</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    taxon <span class="op">=</span> <span class="fu">taxa</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span><span class="op">[</span><span class="va">taxon</span><span class="op">]</span>,</span>
<span>    lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">lag</span><span class="op">)</span>,</span>
<span>    selected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">taxon</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">staxa</span><span class="op">$</span><span class="va">taxa</span><span class="op">)</span>, <span class="st">"Selected"</span>, <span class="st">"Not Selected"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"#d3d3d3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">taxon</span>, <span class="op">-</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, fill <span class="op">=</span> <span class="va">lag</span>, col <span class="op">=</span> <span class="va">lag</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">selected</span>, scales <span class="op">=</span> <span class="st">"free_x"</span>, space <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#c6dbef"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#2171b5"</span>, <span class="st">"#084594"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#c6dbef"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#2171b5"</span>, <span class="st">"#084594"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">M</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"Taxon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="postpartum_files/figure-html/unnamed-chunk-12-1.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="comparing-counterfactual-trajectories">Comparing Counterfactual Trajectories<a class="anchor" aria-label="anchor" href="#comparing-counterfactual-trajectories"></a>
</h3>
<p>Mirror statistics can highlight the species that are the most
influenced by the intervention, but they do not help us describe the
“shape” of an intervention effect. Are there taxa that are immediately
impacted, but which recover quickly? Are there others whose effects are
delayed? Transfer function models can help to answer this question. The
idea is to simulate identical interventions across all subjects using
the fitted model to predict the subsequent taxonomic abundance
trajectories. Do be cautious with interpretation, though. Simpler models
(smaller <span class="math inline">\(P\)</span> and <span class="math inline">\(Q\)</span>) have limited expressivity – there are
only so many shapes they can approximate. That said, the simulated
trajectories often provide a useful summary of intervention effects
across heterogeneous populations.</p>
<p>In the block below, we begin the simulation at the timepoint
immediately before the first observed intervention. From here, we
simulate four counterfactual outcomes. We toggle both (1) whether the
birth intervention occurs and (2) the <code>BirthControlYesNo</code>
variable. The reason for simulating the four combinations is to see
whether the learned intervention effect varies among women who do and do
not use birth control following delivery – the original paper
hypothesizes that there may be a difference, based on prior biological
knowledge and a few examples from the data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps.html">steps</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"birth"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, lengths <span class="op">=</span> <span class="fl">2</span>, L <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">start_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">ts</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">.</span><span class="op">@</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">sim_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bc</span> <span class="op">&lt;-</span> <span class="fu">subject_data</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>BirthControlYesNo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sim_bc</span><span class="op">[[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/counterfactual_ts.html">counterfactual_ts</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ws</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">start_ix</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">replace_subject</span><span class="op">(</span><span class="va">.</span>, <span class="va">bc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="st">"in-sample"</span><span class="op">]</span><span class="op">]</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We visualize a few of the trajectories below. Just so that the figure
is not too large, we’ve restricted attention to just a few of the taxa
that are known to be affected by the intervention. We use the
<code>ribbon_data</code> helper function to extract the 25 and 75%
quantiles of the simulated trajectories. It’s immediately clear which
taxa become more/less abundant in the population. It seems that
trajectories mainly differ in magnitude, but not in shape – all taxa
begin to recover to pre-intervention levels at approximately the same
rate. Moreover, the simulated <code>BirthControlYesNo</code>
trajectories seem identical, indicating that the model has not learned
any potential interaction. The paper’s discussion is still plausible,
but the effect does not seem so strong across the entire population that
it is considered worth learning by the model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">focus_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Porphyromonas"</span>, <span class="st">"Lactobacillus"</span>, <span class="st">"Prevotella_6"</span>, <span class="st">"L.jensenii"</span>, <span class="st">"L.iners"</span>, <span class="st">"Atopobium"</span><span class="op">)</span></span>
<span><span class="va">rdata</span> <span class="op">&lt;-</span> <span class="va">sim_bc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">ribbon_data</span><span class="op">(</span><span class="va">.</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">focus_taxa</span>, delta <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>, .id <span class="op">=</span> <span class="st">"BC"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    BC <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_recode.html" class="external-link">fct_recode</a></span><span class="op">(</span><span class="va">BC</span>, No <span class="op">=</span> <span class="st">"1"</span>, Yes <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">25</span>, <span class="va">time</span> <span class="op">&lt;</span> <span class="fl">80</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F2785C"</span>, <span class="st">"#144673"</span><span class="op">)</span></span>
<span><span class="fu">ribbon_plot</span><span class="op">(</span><span class="va">rdata</span>, group <span class="op">=</span> <span class="st">"BC"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">taxon</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">Delta</span>, <span class="st">" Abundance"</span><span class="op">)</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"Day"</span>, fill <span class="op">=</span> <span class="st">"Birth Control Reinitiated"</span>, col <span class="op">=</span> <span class="st">"Birth Control Reinitiated"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="postpartum_files/figure-html/trajectory_vis-1.png" width="864"></p>
<p>It is always good practice to use model-based summaries to dig deeper
into the original data (this is sometimes called “Progressive
Disclosure” in the data visualization literature). This is more directed
that attempting to visualize all the data at once, but it is also more
critical than just reporting model summaries as if they captured all of
reality. In the heatmaps below, each row is a different sample, and the
rows correspond to the different birth control categories. Similarities
across panels help explain why the model did not learn an intervention
effect. Moreover, the directions of the effects are generally consistent
with the learned effects. Hoever, this is not universal – consider the
subjects whose L.iners abundance increased following delivery! We could
imagine doing a residual analysis to detect these outlying subjects, in
the spirit of (Holmes, 1993).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">values_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pivot_ts.html">pivot_ts</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">taxon</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BirthControlYesNo</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">subject_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vis_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lactobacillus"</span>, <span class="st">"L.iners"</span>, <span class="st">"Porphyromonas"</span>, <span class="st">"Prevotella_6"</span><span class="op">)</span></span>
<span><span class="fu">interaction_hm</span><span class="op">(</span><span class="va">values_df</span>, <span class="va">vis_taxa</span>, <span class="st">"BirthControlYesNo"</span>, <span class="op">-</span><span class="fl">1</span>, width <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="postpartum_files/figure-html/unnamed-chunk-14-1.png" width="960"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kris Sankaran, Pratheepa Jeganathan.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
