knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(glue)
library(fs)
library(tidyverse)
library(mbtransfer)
library(mdsine)
library(tfPaper)
sim_ts <- ts
library(usethis)
set.seed(20230325)
configurations <- dir_ls(params$data_dir) |>
path_abs() |>
method_configurations()
attach(as.list(configurations[params$run_id, ]))
load(as.character(data_path))
hyper <- c(hyper[[1]], list(taxonomy = taxonomy))
interventions_df <- data.frame(interventions) |>
rownames_to_column("sample")
metadata <- metadata |>
left_join(interventions_df) |>
rename(condition = P1)
use_data(sim_ts)
getwd()
ts
sim_ts
load(as.character(data_path))
hyper <- c(hyper[[1]], list(taxonomy = taxonomy))
interventions_df <- data.frame(interventions) |>
rownames_to_column("sample")
metadata <- metadata |>
left_join(interventions_df) |>
rename(condition = P1)
reads[reads > .Machine$integer.max] <- .Machine$integer.max - 1
ts <- reads |>
normalize(normalization, metadata) |>
ts_from_dfs(interventions, metadata, subject_data) |>
interpolate()
ts
sim_ts <- ts
sim_ts
use_data(sim_ts)
getwd()
library(usethis)
use_data(c(1, 2,3))
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(glue)
library(fs)
library(tidyverse)
library(mbtransfer)
library(mdsine)
library(tfPaper)
sim_ts <- ts
set.seed(20230325)
configurations <- dir_ls(params$data_dir) |>
path_abs() |>
method_configurations()
attach(as.list(configurations[params$run_id, ]))
load(as.character(data_path))
hyper <- c(hyper[[1]], list(taxonomy = taxonomy))
interventions_df <- data.frame(interventions) |>
rownames_to_column("sample")
metadata <- metadata |>
left_join(interventions_df) |>
rename(condition = P1)
reads[reads > .Machine$integer.max] <- .Machine$integer.max - 1
ts <- reads |>
normalize(normalization, metadata) |>
ts_from_dfs(interventions, metadata, subject_data) |>
interpolate()
sim_ts <- ts
use_data(sim_ts)
use_testthat()
use_test("ts_index.R")
length(2)
data(sim_ts)
sim_ts
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
ts[[1]]@interventions
new_inter <- matrix(0, ncol = 5, nrow = 1)
replace_inter(sim_ts, new_inter)
sim_ts2 <- replace_inter(sim_ts, new_inter)
interventions(sim_ts2[[1]])
sim_ts2 <- replace_inter(sim_ts, new_inter)
for (i in seq_along(sim_ts)) {
expect_equal(ncol(sim_ts2[[i]]), ncol(sim_ts[[i]]) + 1)
}
test()
library(testthat)
test()
testthat::test_dir()
testthat::test_dir("test")
testthat::test_dir("tests")
ts <- sim_ts
ts[, 1:2]
ts[[1]][ ,1:2]
interventions(ts[[1]][ ,1:2])
ts <- sim_ts
new_inter
start_ix <- ncol(ts) - ncol(new_inter) + 1
start_ix
ncol(ts)
ncol(ts[[1]])
ncol(new_inter)
ts <- ts[[1]]
start_ix <- ncol(ts) - ncol(new_inter) + 1
start_ix
ts <- ts[, seq_len(start_ix)]
dim(ts)
dim(interventions(ts))
interventions(ts) <- cbind(interventions(ts), new_inter)
dim(interventions(ts))
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
ts[[1]]
new_inter
start_ix
replace_inter(ts[[1]], new_inter, NULL)
test <- replace_inter(ts[[1]], new_inter, NULL)
test <- replace_inter_(ts[[1]], new_inter, NULL)
test <- replace_inter_(ts, new_inter, NULL)
test
dim(test)
dim(test)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
new_inter <- matrix(0, ncol = 5, nrow = 1)
sim_ts2 <- replace_inter(sim_ts, new_inter)
warnings()
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
new_inter <- matrix(0, ncol = 5, nrow = 1)
sim_ts2 <- replace_inter(sim_ts, new_inter)
for (i in seq_along(sim_ts)) {
expect_equal(
ncol(interventions(sim_ts2[[i]])),
ncol(interventions(sim_ts[[i]])) + 1
)
}
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
test()
test_dir("test")
test_dir("tests")
weights <- sapply(ts, ncol)
ts <- sim_ts
weights <- sapply(ts, ncol)
ts
weights <- map(ts, ncol)
weights
weights <- map_dbl(ts, ncol)
weights
?sample
sample(seq_along(ts), n, replace = TRUE, prob = weights)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/tests/testthat/test-ts_index.R", echo=TRUE)
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
test_dir("tests")
knitr::opts_chunk$set(echo = TRUE)
data(sim_ts)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mbtransfer)
set.seed(20230325)
data(sim_ts)
ts <- sim_ts
ts
ts_star <- sample_ts()
ts_star <- sample_ts(ts, 30, 6)
values(ts_star[[1]])
counterfactual_interventions(3, 1)
replace_inter(ts_star, ws$w0[, 1])
ws <- counterfactual_interventions(3, 1)
replace_inter(ts_star, ws$w0[, 1])
replace_inter(ts_star, ws$w0[, 1], 4)
ts0 <- replace_inter(ts_star, ws$w0[, 1], 4)
ws$w0[, 1]
ws$w0
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F], 4)
ws <- counterfactual_interventions(3, 1)
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F], 4)
ts <- ts_star
new_inter <- ws$w0[1,, drop=F]
start_ix <- NULL
start_ix <- rep(start_ix, length(ts))
ts = ts[[1]]
start_ix <- ncol(ts) - ncol(new_inter) + 1
start_ix
start_ix
inter <- interventions(ts)[, seq_len(start_ix), drop = FALSE]
inter
interventions(ts) <- cbind(inter, new_inter)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/ts_index.R", echo=TRUE)
ts_star <- sample_ts(ts, 30, 6)
ts <- sim_ts
ts_star <- sample_ts(ts, 30, 6)
ws <- counterfactual_interventions(3, 1)
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F], 4)
ts0
interventions(ts0[[1]])
interventions(ts0[[2]])
interventions(ts0[[4]])
interventions(ts0[[5]])
ws
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F])
ts0
interventions(ts0[[5]])
dim(interventions(ts0[[5]]))
dim(values(ts0[[5]]))
fit <- mbtransfer(ts)
predict(ts0)
class(fit)
predict(fit, ts0)
predict(fit, ts)
dim(values(ts0[[1]]))
dim(interventions(ts0[[1]]))
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/model.R", echo=TRUE)
predict(fit, ts0)
t1
t2
dim(pre)
dim(interventions(series_i))
t1
t2
seq(t1 + 1, t2)
inteventions
interventions
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mbtransfer)
set.seed(20230325)
sapply(list.files("R"), source)
data(sim_ts)
ts <- sim_ts
devtools::document(); devtools::install();
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mbtransfer)
set.seed(20230325)
sapply(list.files("R"), source)
data(sim_ts)
ts <- sim_ts
ts_star <- sample_ts(ts, 30, 6)
list.files("R")
sapply(list.files("R"), source)
sapply(list.files("R", full = TRUE), source)
map(list.files("R", full = TRUE), source)
map(list.files("../mbtransfer/R", full = TRUE), source)
data(sim_ts)
ts <- sim_ts
ts_star <- sample_ts(ts, 30, 6)
ws <- counterfactual_interventions(3, 1)
library(glue)
library(fs)
ts_star <- sample_ts(ts, 30, 6)
ws <- counterfactual_interventions(3, 1)
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F])
fit <- mbtransfer(ts, nrounds = 2)
library(slider)
fit <- mbtransfer(ts, nrounds = 2)
library(xgboost)
fit <- mbtransfer(ts, nrounds = 2)
predict(fit, ts0)
fit
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/model.R", echo=TRUE)
fit <- mbtransfer(ts, nrounds = 2)
predict(fit, ts0)
traceback()
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/model.R", echo=TRUE)
predict(fit, ts0)
?seq
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/patches.R", echo=TRUE)
#fit <- mbtransfer(ts, nrounds = 2)
predict(fit, ts0)
lags
dim(x_prev)
dim(w_prev)
w
w_prev
x_prev
dim(x_prev)
dim(w_prev)
dim(values(ts_inter))
dim(interventions(ts_inter))
seq(n_time - lags[1] + 1, by = 1, length.out = lags[1])
seq(n_time - lags[2] + 2, by = 1, length.out = lags[2])
w
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/patches.R", echo=TRUE)
#fit <- mbtransfer(ts, nrounds = 2)
predict(fit, ts0)
#fit <- mbtransfer(ts, nrounds = 2)
y_hat <- predict(fit, ts0)
dim(y_hat[[1]])
dim(ts0[[1]])
ws[[1]]
?counterfactual_interventions
counterfactual_interventions
ts_star[[1]]
dim(ts_star[[1]])
ts_star <- sample_ts(ts, 30, 6)
ws <- counterfactual_interventions(6, 1)
ts0 <- replace_inter(ts_star, ws$w0[1,, drop=F], start_ix = 6)
ts0[[1]]
dim(ts0[[1]])
dim(interventions(ts0[[1]]))
ws <- counterfactual_interventions(6, 1)
ws$w1
ts_star <- sample_ts(ts, 30, 6)
ws <- counterfactual_interventions(6, 1)
ts0 <- replace_inter(ts_star, ws$w1[nrow(ws$w1),, drop=F], start_ix = 6)
dim(interventions(ts0[[1]]))
interventions(ts0[[1]])
ts1 <- replace_inter(ts_star, ws$w1[nrow(ws$w1),, drop=F], start_ix = 6)
#fit <- mbtransfer(ts, nrounds = 2)
y_hat <- predict(fit, ts0)
#fit <- mbtransfer(ts, nrounds = 2)
y_hat <- predict(fit, ts1)
dim(y_hat[[1]])
plot(values(y_hat[[1]])[1, ])
plot(values(y_hat[[2]])[1, ])
plot(values(y_hat[[10]])[1, ])
plot(values(y_hat[[10]])[2, ])
plot(values(y_hat[[10]])[3, ])
plot(values(y_hat[[10]])[5, ])
inter
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
ts
intervention_patterns(ts, "P1", c(0, 1))
intervention_patterns(interventions(ts), "P1")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
intervention_patterns(interventions(ts[[1]]), "P1")
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
intervention_patterns(inter, "P1", lags = 1:3, L = 4)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
pulses(inter, "P1", lags = 1 L = 4)
pulses(inter, "P1", lags = 1, L = 4)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
res <- steps(inter, "P1", starts = 1:3, lengths = 2:3, L = 4)
unique(res)
source("~/Desktop/collaborations/microbiome_interventions/mbtransfer/R/pd-tests.R", echo=TRUE)
pulses(inter, "P1", seq(0, 1, 0.2), lags = 1:3, L = 4)
